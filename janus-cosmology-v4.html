<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JANUS v4 â€” Simulation Cosmologique BimÃ©trique + DESI 2024</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #020306;
            --panel: rgba(6, 10, 20, 0.96);
            --card: rgba(12, 20, 36, 0.9);
            --border: rgba(0, 200, 255, 0.12);
            --text: #e4ecf4;
            --dim: #5a7090;
            --accent: #00d4ff;
            --positive: #00ff88;
            --negative: #ff5544;
            --ocean: #6040ff;
            --void: #200840;
            --blackhole: #ff00ff;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }
        
        #canvas { position: fixed; inset: 0; z-index: 1; }
        
        /* Panels */
        .panel {
            position: fixed;
            top: 0;
            height: 100vh;
            background: var(--panel);
            backdrop-filter: blur(20px);
            z-index: 100;
            overflow-y: auto;
            border: 1px solid var(--border);
            padding: 16px;
        }
        
        .panel::-webkit-scrollbar { width: 4px; }
        .panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        
        .panel-left { left: 0; width: 300px; }
        .panel-right { right: 0; width: 320px; }
        
        h1 {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent), var(--positive));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle { font-size: 9px; color: var(--dim); margin-bottom: 16px; letter-spacing: 0.5px; }
        
        .section { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .section-title { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--dim); margin-bottom: 10px; }
        
        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 10px;
        }
        
        .card.highlight { background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(0,255,136,0.05)); border-color: rgba(0,212,255,0.3); }
        .card.desi { background: linear-gradient(135deg, rgba(255,100,0,0.1), rgba(255,200,0,0.05)); border-color: rgba(255,150,0,0.3); }
        .card.janus { background: linear-gradient(135deg, rgba(96,64,255,0.1), rgba(0,212,255,0.05)); border-color: rgba(96,64,255,0.3); }
        
        .card-title { font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .note { color: var(--dim); line-height: 1.5; font-size: 9px; }
        
        .eq {
            font-family: monospace;
            font-size: 11px;
            color: var(--accent);
            background: rgba(0,0,0,0.3);
            padding: 5px 8px;
            border-radius: 4px;
            margin: 6px 0;
            border-left: 2px solid var(--accent);
        }
        
        /* Mode tabs */
        .mode-tabs { display: flex; gap: 3px; margin-bottom: 12px; }
        
        .mode-tab {
            flex: 1;
            padding: 8px 4px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--dim);
            font-size: 9px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .mode-tab:hover { color: var(--text); }
        .mode-tab.active { background: rgba(0,212,255,0.15); border-color: var(--accent); color: var(--text); }
        .mode-tab.janus.active { background: rgba(96,64,255,0.15); border-color: var(--ocean); }
        
        /* Scenarios */
        .scenario-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        
        .scenario-btn {
            padding: 10px 6px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--dim);
            font-size: 9px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .scenario-btn:hover { border-color: var(--accent); color: var(--text); }
        .scenario-btn.active { background: rgba(0,212,255,0.1); border-color: var(--accent); color: var(--accent); }
        .scenario-btn .icon { font-size: 16px; display: block; margin-bottom: 4px; }
        
        /* Controls */
        .control-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .control-label { font-size: 10px; min-width: 90px; }
        .control-value { font-family: monospace; font-size: 10px; color: var(--accent); min-width: 40px; text-align: right; }
        
        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 12px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .btn-row { display: flex; gap: 4px; margin-top: 8px; }
        
        .btn {
            flex: 1;
            padding: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover { border-color: var(--accent); }
        .btn.active { background: rgba(0,212,255,0.15); border-color: var(--accent); }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        
        .stat {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 8px;
        }
        
        .stat-label { font-size: 7px; color: var(--dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-family: monospace; font-size: 14px; color: var(--accent); margin-top: 2px; }
        .stat-value.pos { color: var(--positive); }
        .stat-value.neg { color: var(--negative); }
        .stat-value.ocean { color: var(--ocean); }
        
        /* Top bar */
        .top-bar {
            position: fixed;
            top: 10px;
            left: 320px;
            right: 340px;
            padding: 10px 16px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .top-item { text-align: center; }
        .top-label { font-size: 7px; color: var(--dim); text-transform: uppercase; }
        .top-value { font-family: monospace; font-size: 12px; color: var(--accent); }
        
        /* Legend */
        .legend {
            position: fixed;
            bottom: 10px;
            left: 320px;
            padding: 8px 14px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            z-index: 100;
            display: flex;
            gap: 14px;
        }
        
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 9px; color: var(--dim); }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
        
        /* Fullscreen */
        body.fullscreen .panel, body.fullscreen .top-bar, body.fullscreen .legend { display: none !important; }
        .fs-hint { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 8px 16px; background: var(--panel); border: 1px solid var(--border); border-radius: 6px; font-size: 10px; color: var(--dim); z-index: 200; }
        body.fullscreen .fs-hint { display: block; }
        
        /* DESI indicator */
        .desi-badge {
            display: inline-block;
            padding: 2px 6px;
            background: linear-gradient(90deg, #ff6600, #ffaa00);
            border-radius: 3px;
            font-size: 8px;
            font-weight: 700;
            color: #000;
            margin-left: 6px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="fs-hint">Appuyez sur F ou ESC pour quitter</div>
    
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-item">
            <div class="top-label">Mode</div>
            <div class="top-value" id="top-mode">JANUS+DESI</div>
        </div>
        <div class="top-item">
            <div class="top-label">Galaxies</div>
            <div class="top-value" id="top-galaxies">0</div>
        </div>
        <div class="top-item">
            <div class="top-label">DensitÃ© OcÃ©an mâ»</div>
            <div class="top-value" id="top-ocean">0</div>
        </div>
        <div class="top-item">
            <div class="top-label">Pression</div>
            <div class="top-value" id="top-pressure">0</div>
        </div>
        <div class="top-item">
            <div class="top-label">Temps</div>
            <div class="top-value" id="top-time">0 Gyr</div>
        </div>
        <div class="top-item">
            <div class="top-label">AccÃ©lÃ©ration</div>
            <div class="top-value" id="top-accel">0</div>
        </div>
        <div class="top-item">
            <div class="top-label">FPS</div>
            <div class="top-value" id="top-fps">60</div>
        </div>
    </div>
    
    <!-- Left Panel -->
    <div class="panel panel-left">
        <h1>JANUS v4</h1>
        <div class="subtitle">COSMOLOGIE BIMÃ‰TRIQUE â€” DONNÃ‰ES DESI 2024-2025</div>
        
        <!-- Mode Selection -->
        <div class="section">
            <div class="section-title">Mode de Simulation</div>
            <div class="mode-tabs">
                <div class="mode-tab" id="tab-standard" onclick="setMode('standard')">
                    <div>Standard</div>
                    <div style="font-size:7px;color:var(--negative)">Î›CDM+triche</div>
                </div>
                <div class="mode-tab" id="tab-relativity" onclick="setMode('relativity')">
                    <div>RelativitÃ©</div>
                    <div style="font-size:7px;color:var(--negative)">S'effondre</div>
                </div>
                <div class="mode-tab janus active" id="tab-janus" onclick="setMode('janus')">
                    <div>Janus+DESI</div>
                    <div style="font-size:7px;color:var(--positive)">Stable âœ“</div>
                </div>
            </div>
        </div>
        
        <!-- DESI Info -->
        <div class="section" id="desi-section">
            <div class="section-title">RÃ©sultats DESI 2024-2025 <span class="desi-badge">NEW</span></div>
            <div class="card desi">
                <div class="card-title">ğŸ“Š L'Ã©nergie sombre Ã‰VOLUE</div>
                <div class="note">
                    DESI a montrÃ© que l'Ã©nergie sombre n'est <strong>PAS constante</strong> (Î›).<br><br>
                    â†’ Elle <strong>s'affaiblit</strong> ou <strong>se renforce</strong> avec le temps<br>
                    â†’ Le modÃ¨le Î›CDM montre des "fissures"<br>
                    â†’ <strong>Janus prÃ©dit exactement cela !</strong>
                </div>
            </div>
        </div>
        
        <!-- Physics Explanation -->
        <div class="section">
            <div class="section-title">Physique Janus</div>
            
            <div class="card janus">
                <div class="card-title">ğŸŒŠ L'OcÃ©an de Masse NÃ©gative</div>
                <div class="note">
                    <strong>95% de l'univers</strong> = ocÃ©an mâ» (invisible)<br>
                    <strong>5% matiÃ¨re visible</strong> = galaxies immergÃ©es<br><br>
                    Cet ocÃ©an exerce une <strong>PRESSION ISOTROPE</strong> qui :<br>
                    â€¢ Confine les galaxies<br>
                    â€¢ Les aplatit en disques<br>
                    â€¢ EmpÃªche leur fusion
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">âš« Voids & ConglomÃ©rats mâ»</div>
                <div class="note">
                    Les grands <strong>VOIDS</strong> cosmiques contiennent des <strong>conglomÃ©rats de masse nÃ©gative</strong> (invisibles).<br><br>
                    Ex: Le <strong>Dipole Repeller</strong> = amas mâ» qui repousse les galaxies.
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ•³ï¸ Trou Noir Central (Sgr A*)</div>
                <div class="eq">M_SgrA* â‰ˆ 4Ã—10â¶ Mâ˜‰</div>
                <div class="note">
                    Chaque galaxie a un trou noir supermassif au centre qui interagit avec l'ocÃ©an mâ».
                </div>
            </div>
        </div>
        
        <!-- Scenarios -->
        <div class="section">
            <div class="section-title">ScÃ©narios</div>
            <div class="scenario-grid">
                <div class="scenario-btn active" id="sc-observable" onclick="loadScenario('observable')">
                    <span class="icon">ğŸ”­</span>
                    Univers Observable
                </div>
                <div class="scenario-btn" id="sc-bigbang" onclick="loadScenario('bigbang')">
                    <span class="icon">ğŸ’¥</span>
                    Big Bang
                </div>
                <div class="scenario-btn" id="sc-milkyway" onclick="loadScenario('milkyway')">
                    <span class="icon">ğŸŒ€</span>
                    Voie LactÃ©e
                </div>
                <div class="scenario-btn" id="sc-desi" onclick="loadScenario('desi')">
                    <span class="icon">ğŸ“ˆ</span>
                    Test DESI
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="section">
            <div class="section-title">ParamÃ¨tres</div>
            
            <div class="control-row">
                <span class="control-label">Vitesse</span>
                <input type="range" id="ctrl-speed" min="0" max="5" step="0.1" value="1">
                <span class="control-value" id="val-speed">1.0Ã—</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">GravitÃ© G</span>
                <input type="range" id="ctrl-gravity" min="0.1" max="3" step="0.1" value="1">
                <span class="control-value" id="val-gravity">1.0</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">Ratio mâ»/mâº</span>
                <input type="range" id="ctrl-ratio" min="10" max="100" step="5" value="50">
                <span class="control-value" id="val-ratio">50Ã—</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">Pression OcÃ©an</span>
                <input type="range" id="ctrl-pressure" min="0" max="5" step="0.1" value="2">
                <span class="control-value" id="val-pressure">2.0</span>
            </div>
            
            <div class="control-row">
                <span class="control-label">Ã‰volution w(t)</span>
                <input type="range" id="ctrl-evolution" min="0" max="2" step="0.1" value="1">
                <span class="control-value" id="val-evolution">1.0</span>
            </div>
            
            <div class="btn-row">
                <button class="btn active" id="btn-pause" onclick="togglePause()">â¸ Pause</button>
                <button class="btn" onclick="reset()">â†» Reset</button>
                <button class="btn" onclick="toggleFS()">â›¶ Plein</button>
            </div>
        </div>
    </div>
    
    <!-- Right Panel -->
    <div class="panel panel-right">
        <div class="section">
            <div class="section-title">Statistiques Univers</div>
            <div class="stats-grid">
                <div class="stat">
                    <div class="stat-label">Galaxies mâº</div>
                    <div class="stat-value pos" id="stat-galaxies">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Masse Totale mâº</div>
                    <div class="stat-value pos" id="stat-mass-pos">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Masse OcÃ©an mâ»</div>
                    <div class="stat-value ocean" id="stat-mass-neg">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Voids DÃ©tectÃ©s</div>
                    <div class="stat-value" id="stat-voids">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Pression Moyenne</div>
                    <div class="stat-value" id="stat-pressure">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">StabilitÃ©</div>
                    <div class="stat-value" id="stat-stability">0%</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Ã‰quilibre des Forces</div>
            <div class="card">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <span style="color:var(--positive)">GravitÃ© (attraction)</span>
                    <span id="force-grav">0</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <span style="color:var(--ocean)">Pression ocÃ©an mâ»</span>
                    <span id="force-ocean">0</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <span style="color:var(--blackhole)">Trou noir central</span>
                    <span id="force-bh">0</span>
                </div>
                <div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px;">
                    <span style="font-weight:600">Ã‰tat</span>
                    <span id="state" style="color:var(--positive)">--</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">ğŸ¯ Preuve DESI: Vitesse par Zone</div>
            <div class="card desi">
                <div class="note" style="margin-bottom:8px;">
                    Si Janus est correct, les galaxies <strong>LOINTAINES</strong> doivent aller <strong>PLUS VITE</strong> que les proches (plus de vide = plus d'accÃ©lÃ©ration).
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span>Galaxies proches (&lt;150)</span>
                    <span id="vel-inner" style="color:var(--accent)">--</span>
                </div>
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span>Galaxies lointaines (&gt;150)</span>
                    <span id="vel-outer" style="color:var(--accent)">--</span>
                </div>
                <div style="display:flex;justify-content:space-between;border-top:1px solid var(--border);padding-top:6px;margin-top:6px;">
                    <span style="font-weight:600">Ratio (doit Ãªtre &gt;1)</span>
                    <span id="vel-ratio" style="color:var(--positive);font-weight:700">--</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">PrÃ©dictions VÃ©rifiÃ©es</div>
            <div class="card">
                <div id="pred-flat" style="margin-bottom:4px;">â³ Courbes rotation plates</div>
                <div id="pred-stable" style="margin-bottom:4px;">â³ Galaxies stables</div>
                <div id="pred-disk" style="margin-bottom:4px;">â³ Galaxies aplaties</div>
                <div id="pred-accel" style="margin-bottom:4px;">â³ Expansion accÃ©lÃ©rÃ©e</div>
                <div id="pred-desi" style="margin-bottom:4px;">â³ w(t) Ã©volutif (DESI)</div>
                <div id="pred-voids">â³ Structure lacunaire</div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Comparaison des ModÃ¨les</div>
            <div class="card">
                <table style="width:100%;font-size:8px;border-collapse:collapse;">
                    <tr style="border-bottom:1px solid var(--border);">
                        <th style="text-align:left;padding:3px;">Aspect</th>
                        <th style="padding:3px;">Î›CDM</th>
                        <th style="padding:3px;">Janus</th>
                    </tr>
                    <tr>
                        <td style="padding:3px;">MatiÃ¨re noire</td>
                        <td style="padding:3px;text-align:center;color:var(--negative)">27% ?</td>
                        <td style="padding:3px;text-align:center;color:var(--positive)">Non</td>
                    </tr>
                    <tr>
                        <td style="padding:3px;">Ã‰nergie sombre</td>
                        <td style="padding:3px;text-align:center;color:var(--negative)">68% ?</td>
                        <td style="padding:3px;text-align:center;color:var(--positive)">OcÃ©an mâ»</td>
                    </tr>
                    <tr>
                        <td style="padding:3px;">StabilitÃ©</td>
                        <td style="padding:3px;text-align:center;color:var(--negative)">Triche</td>
                        <td style="padding:3px;text-align:center;color:var(--positive)">Naturelle</td>
                    </tr>
                    <tr>
                        <td style="padding:3px;">w(t) Ã©volutif</td>
                        <td style="padding:3px;text-align:center;color:var(--negative)">Non</td>
                        <td style="padding:3px;text-align:center;color:var(--positive)">Oui âœ“</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--accent);"></div>Galaxie lente</div>
        <div class="legend-item"><div class="legend-dot" style="background:linear-gradient(90deg, #00d4ff, #ffaa00);"></div>â†’ accÃ©lÃ¨re</div>
        <div class="legend-item"><div class="legend-dot" style="background:#ff6644;"></div>Galaxie rapide</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--ocean);"></div>OcÃ©an mâ»</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--void);"></div>Void</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--blackhole);"></div>Trou Noir</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // JANUS v4 â€” COSMOLOGIE BIMÃ‰TRIQUE + DESI 2024-2025
        // Based on Jean-Pierre Petit's research & DESI collaboration results
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const PHYSICS = {
            G: 1.0,
            SOFTENING: 5.0,
            DT: 0.012,
            UNIVERSE_RADIUS: 500,
            VOID_RADIUS: 80,
            BLACK_HOLE_MASS: 5000,  // Sgr A* equivalent
        };
        
        const CONFIG = {
            mode: 'janus',
            speed: 1.0,
            gravity: 1.0,
            massRatio: 50,          // mâ»/mâº ratio
            oceanPressure: 2.0,
            darkEnergyEvolution: 1.0,  // w(t) evolution factor (DESI)
            paused: false,
            scenario: 'observable',
        };
        
        const UNIVERSE = {
            galaxies: [],
            voids: [],
            blackHoles: [],
            oceanParticles: null,
            time: 0,
            cosmicTime: 0,  // In Gyr
            avgPressure: 0,
            totalAcceleration: 0,
        };
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THREE.JS SETUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const canvas = document.getElementById('canvas');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020306);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 3000);
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        
        // Groups
        const galaxyGroup = new THREE.Group();
        const oceanGroup = new THREE.Group();
        const voidGroup = new THREE.Group();
        const blackHoleGroup = new THREE.Group();
        scene.add(galaxyGroup, oceanGroup, voidGroup, blackHoleGroup);
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GALAXY CLASS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class Galaxy {
            constructor(mass, pos, vel) {
                this.mass = mass;
                this.position = pos.clone();
                this.velocity = vel.clone();
                this.force = new THREE.Vector3();
                this.radius = Math.pow(mass, 0.25) * 2.5;
                this.hasBlackHole = mass > 300;
                this.blackHoleMass = this.hasBlackHole ? mass * 0.01 : 0;
                
                this.createMesh();
            }
            
            createMesh() {
                const group = new THREE.Group();
                
                // Galaxy core
                const coreGeom = new THREE.SphereGeometry(this.radius * 0.25, 16, 16);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0x00d4ff });
                group.add(new THREE.Mesh(coreGeom, coreMat));
                
                // Black hole at center (if massive enough)
                if (this.hasBlackHole) {
                    const bhGeom = new THREE.SphereGeometry(this.radius * 0.08, 12, 12);
                    const bhMat = new THREE.MeshBasicMaterial({ color: 0xff00ff });
                    const bh = new THREE.Mesh(bhGeom, bhMat);
                    group.add(bh);
                    
                    // Accretion disk
                    const diskGeom = new THREE.RingGeometry(this.radius * 0.1, this.radius * 0.25, 32);
                    const diskMat = new THREE.MeshBasicMaterial({ 
                        color: 0xff8800, 
                        transparent: true, 
                        opacity: 0.6,
                        side: THREE.DoubleSide 
                    });
                    const disk = new THREE.Mesh(diskGeom, diskMat);
                    disk.rotation.x = Math.PI / 2;
                    group.add(disk);
                }
                
                // Galactic disk (flat!)
                const diskGeom = new THREE.RingGeometry(this.radius * 0.3, this.radius * 1.5, 48);
                const diskMat = new THREE.MeshBasicMaterial({
                    color: 0x00aaff,
                    transparent: true,
                    opacity: 0.25,
                    side: THREE.DoubleSide
                });
                const galDisk = new THREE.Mesh(diskGeom, diskMat);
                galDisk.rotation.x = Math.PI / 2;
                group.add(galDisk);
                
                // Spiral arms
                const armGeom = new THREE.BufferGeometry();
                const positions = [];
                const colors = [];
                
                for (let arm = 0; arm < 2; arm++) {
                    for (let i = 0; i < 80; i++) {
                        const t = (i / 80) * Math.PI * 2.5;
                        const r = this.radius * 0.2 + t * this.radius * 0.2;
                        const theta = t + arm * Math.PI;
                        const spread = 0.3 + t * 0.1;
                        
                        positions.push(
                            r * Math.cos(theta) + (Math.random() - 0.5) * spread,
                            (Math.random() - 0.5) * 0.15,  // Very flat!
                            r * Math.sin(theta) + (Math.random() - 0.5) * spread
                        );
                        
                        const brightness = 0.5 + Math.random() * 0.5;
                        colors.push(0, brightness, brightness);
                    }
                }
                
                armGeom.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                armGeom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                
                const armMat = new THREE.PointsMaterial({
                    size: 0.4,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.8
                });
                group.add(new THREE.Points(armGeom, armMat));
                
                group.position.copy(this.position);
                this.mesh = group;
                galaxyGroup.add(group);
            }
            
            update() {
                if (this.mesh) {
                    this.mesh.position.copy(this.position);
                    this.mesh.rotation.y += 0.003 * CONFIG.speed;
                    
                    // Color based on velocity (shows acceleration!)
                    const speed = this.velocity.length();
                    const maxSpeed = 5;
                    const speedRatio = Math.min(1, speed / maxSpeed);
                    
                    // Slow = cyan, Fast = yellow/red
                    const r = speedRatio;
                    const g = 0.8 - speedRatio * 0.5;
                    const b = 1 - speedRatio;
                    
                    // Update core color
                    if (this.mesh.children[0] && this.mesh.children[0].material) {
                        this.mesh.children[0].material.color.setRGB(r, g, b);
                    }
                    
                    // Update trail/halo based on local ocean density
                    if (this.localOceanDensity !== undefined) {
                        const oceanIntensity = this.localOceanDensity / (CONFIG.massRatio * 1.5);
                        // Could add visual effect here
                    }
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VOID CLASS (cosmic voids with negative mass concentration)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        class Void {
            constructor(pos, radius, negativeMass) {
                this.position = pos.clone();
                this.radius = radius;
                this.negativeMass = negativeMass;
                
                this.createMesh();
            }
            
            createMesh() {
                // Void sphere (semi-transparent dark region)
                const geom = new THREE.SphereGeometry(this.radius, 24, 24);
                const mat = new THREE.MeshBasicMaterial({
                    color: 0x200840,
                    transparent: true,
                    opacity: 0.15,
                    side: THREE.BackSide
                });
                
                this.mesh = new THREE.Mesh(geom, mat);
                this.mesh.position.copy(this.position);
                
                // Negative mass concentration at center (invisible but represented)
                const centerGeom = new THREE.SphereGeometry(this.radius * 0.3, 16, 16);
                const centerMat = new THREE.MeshBasicMaterial({
                    color: 0x4020ff,
                    transparent: true,
                    opacity: 0.1
                });
                const center = new THREE.Mesh(centerGeom, centerMat);
                this.mesh.add(center);
                
                voidGroup.add(this.mesh);
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OCEAN OF NEGATIVE MASS (continuous fluid)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function createOcean() {
            oceanGroup.clear();
            
            // Particle representation of the negative mass ocean
            const particleCount = 5000;
            const positions = [];
            const colors = [];
            
            for (let i = 0; i < particleCount; i++) {
                // Distribute throughout the universe
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                const r = Math.random() * PHYSICS.UNIVERSE_RADIUS;
                
                const x = r * Math.sin(phi) * Math.cos(theta);
                const y = (Math.random() - 0.5) * 100;  // Compressed vertically
                const z = r * Math.sin(phi) * Math.sin(theta);
                
                positions.push(x, y, z);
                
                // Purple-blue color for negative mass
                colors.push(0.3 + Math.random() * 0.2, 0.1, 0.5 + Math.random() * 0.3);
            }
            
            const geom = new THREE.BufferGeometry();
            geom.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geom.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const mat = new THREE.PointsMaterial({
                size: 1.0,
                vertexColors: true,
                transparent: true,
                opacity: 0.15
            });
            
            UNIVERSE.oceanParticles = new THREE.Points(geom, mat);
            oceanGroup.add(UNIVERSE.oceanParticles);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHYSICS ENGINE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function computeForces() {
            UNIVERSE.galaxies.forEach(g => g.force.set(0, 0, 0));
            
            if (CONFIG.mode === 'standard') {
                computeStandardForces();
            } else if (CONFIG.mode === 'relativity') {
                computeRelativityForces();
            } else {
                computeJanusForces();
            }
        }
        
        function computeStandardForces() {
            // Î›CDM with artificial stabilization (cheating!)
            const galaxies = UNIVERSE.galaxies;
            
            for (let i = 0; i < galaxies.length; i++) {
                for (let j = i + 1; j < galaxies.length; j++) {
                    const g1 = galaxies[i];
                    const g2 = galaxies[j];
                    
                    const r = new THREE.Vector3().subVectors(g2.position, g1.position);
                    const dist = Math.max(r.length(), PHYSICS.SOFTENING);
                    r.normalize();
                    
                    // Gravity + fake dark matter halo
                    let F = PHYSICS.G * CONFIG.gravity * g1.mass * g2.mass / (dist * dist);
                    F -= 0.02 * g1.mass * g2.mass / (dist * dist * dist);  // FAKE!
                    
                    const force = r.multiplyScalar(F);
                    g1.force.add(force);
                    g2.force.sub(force);
                }
                
                // Fake dark energy expansion
                const hubble = 0.00005 * CONFIG.darkEnergyEvolution;
                galaxies[i].force.add(
                    new THREE.Vector3(galaxies[i].position.x, 0, galaxies[i].position.z)
                    .multiplyScalar(hubble * galaxies[i].mass)
                );
            }
        }
        
        function computeRelativityForces() {
            // Pure Newton/Einstein - NO stabilization = COLLAPSE!
            const galaxies = UNIVERSE.galaxies;
            
            for (let i = 0; i < galaxies.length; i++) {
                for (let j = i + 1; j < galaxies.length; j++) {
                    const g1 = galaxies[i];
                    const g2 = galaxies[j];
                    
                    const r = new THREE.Vector3().subVectors(g2.position, g1.position);
                    const dist = Math.max(r.length(), PHYSICS.SOFTENING);
                    r.normalize();
                    
                    // Pure gravity only
                    const F = PHYSICS.G * CONFIG.gravity * g1.mass * g2.mass / (dist * dist);
                    
                    const force = r.multiplyScalar(F);
                    g1.force.add(force);
                    g2.force.sub(force);
                }
            }
        }
        
        function computeJanusForces() {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // JANUS + DESI: Ocean of negative mass + evolving w(t)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            //
            // CLÃ‰ DE LA PHYSIQUE (DESI 2024-2025):
            // - Plus une galaxie est LOIN â†’ Plus elle est dans le VIDE
            // - Plus de vide = Plus d'ocÃ©an mâ» = Plus de RÃ‰PULSION
            // - Donc : ACCÃ‰LÃ‰RATION augmente avec la distance !
            //
            // Ïâ»_local = Ïâ»_base Ã— (1 - densitÃ©_matiÃ¨re_locale)
            // F_expansion = Ïâ»_local Ã— m Ã— r (proportionnel Ã  la distance!)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            const galaxies = UNIVERSE.galaxies;
            const oceanBaseDensity = CONFIG.massRatio;
            const pressureCoeff = CONFIG.oceanPressure;
            const wEvolution = CONFIG.darkEnergyEvolution;
            
            // Time-dependent w(t) from DESI
            const cosmicAge = UNIVERSE.cosmicTime;
            const wFactor = 1 + 0.2 * wEvolution * (1 - Math.exp(-cosmicAge * 0.05));
            
            let totalGrav = 0, totalOcean = 0, totalBH = 0;
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // STEP 1: Calculate LOCAL MATTER DENSITY at each galaxy position
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            galaxies.forEach(g => {
                g.localMatterDensity = 0;
                g.localOceanDensity = oceanBaseDensity;
            });
            
            // Count nearby matter to determine local density
            for (let i = 0; i < galaxies.length; i++) {
                for (let j = 0; j < galaxies.length; j++) {
                    if (i === j) continue;
                    const dist = galaxies[i].position.distanceTo(galaxies[j].position);
                    // Closer galaxies contribute more to local density
                    const contribution = galaxies[j].mass / (dist * dist + 100);
                    galaxies[i].localMatterDensity += contribution;
                }
            }
            
            // Normalize and calculate ocean density (inverse of matter density!)
            let maxDensity = 0;
            galaxies.forEach(g => { if (g.localMatterDensity > maxDensity) maxDensity = g.localMatterDensity; });
            
            galaxies.forEach(g => {
                const normalizedMatter = maxDensity > 0 ? g.localMatterDensity / maxDensity : 0;
                // CRUCIAL: Ocean density is HIGH where matter density is LOW!
                g.localOceanDensity = oceanBaseDensity * (1 - normalizedMatter * 0.8) * wFactor;
            });
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // STEP 2: Apply forces
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            for (let i = 0; i < galaxies.length; i++) {
                const g1 = galaxies[i];
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // 2a. GRAVITY BETWEEN GALAXIES (attraction)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                for (let j = i + 1; j < galaxies.length; j++) {
                    const g2 = galaxies[j];
                    
                    const r = new THREE.Vector3().subVectors(g2.position, g1.position);
                    const dist = Math.max(r.length(), PHYSICS.SOFTENING);
                    const rNorm = r.clone().normalize();
                    
                    // Newton gravity
                    const F_grav = PHYSICS.G * CONFIG.gravity * g1.mass * g2.mass / (dist * dist);
                    totalGrav += F_grav;
                    
                    // Ocean pressure BETWEEN the two galaxies
                    // Less ocean between close galaxies = less repulsion between them
                    // More ocean between distant galaxies = more repulsion
                    const avgOceanDensity = (g1.localOceanDensity + g2.localOceanDensity) / 2;
                    const oceanVolumeBetween = dist * dist * dist;  // Grows with distance!
                    const F_ocean = pressureCoeff * avgOceanDensity * (g1.mass + g2.mass) * dist / (oceanVolumeBetween + 1000);
                    totalOcean += F_ocean;
                    
                    // Net force: gravity pulls, ocean pushes
                    const F_net = F_grav - F_ocean * 0.5;
                    const force = rNorm.multiplyScalar(F_net);
                    g1.force.add(force);
                    g2.force.sub(force);
                }
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // 2b. VOID REPULSION - Voids have MAXIMUM ocean density!
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                UNIVERSE.voids.forEach(v => {
                    const r = new THREE.Vector3().subVectors(g1.position, v.position);
                    const dist = Math.max(r.length(), PHYSICS.SOFTENING);
                    const rNorm = r.clone().normalize();
                    
                    // Voids are FULL of negative mass â†’ strong repulsion
                    // Force INCREASES as you get closer to the void center
                    // But also affects distant galaxies proportionally to void mass
                    const voidOceanDensity = oceanBaseDensity * 1.5 * wFactor;  // Extra dense!
                    const F_void = voidOceanDensity * v.negativeMass * g1.mass / (dist * dist + 500);
                    
                    g1.force.add(rNorm.multiplyScalar(F_void * 0.01));
                    totalOcean += F_void * 0.01;
                });
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // 2c. COSMIC EXPANSION - THE KEY INSIGHT!
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // Force is proportional to:
                // - LOCAL ocean density (high in voids, low in clusters)
                // - DISTANCE from center (more ocean accumulated)
                // - Galaxy mass
                //
                // Result: Distant galaxies in low-density regions ACCELERATE!
                
                const radialDist = Math.sqrt(g1.position.x * g1.position.x + g1.position.z * g1.position.z);
                
                // The MORE ocean between galaxy and center â†’ MORE repulsion
                // This naturally produces ACCELERATION at large distances!
                const accumulatedOcean = g1.localOceanDensity * radialDist;
                const expansionForce = accumulatedOcean * g1.mass * 0.000015 * wFactor;
                
                const radialDir = new THREE.Vector3(g1.position.x, 0, g1.position.z).normalize();
                g1.force.add(radialDir.multiplyScalar(expansionForce));
                
                totalOcean += expansionForce;
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // 2d. VERTICAL COMPRESSION (why galaxies are FLAT)
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const targetY = 0;
                const yDiff = targetY - g1.position.y;
                const F_y = pressureCoeff * g1.mass * yDiff * 0.015;
                g1.force.y += F_y;
                g1.velocity.y *= 0.9;
                
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // 2e. BLACK HOLE keeps galaxy bound
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (g1.hasBlackHole) {
                    totalBH += g1.blackHoleMass * 0.001 * g1.mass;
                }
            }
            
            // Update stats
            UNIVERSE.avgPressure = totalOcean / Math.max(1, galaxies.length);
            UNIVERSE.totalAcceleration = totalOcean - totalGrav;
            
            document.getElementById('force-grav').textContent = totalGrav.toFixed(1);
            document.getElementById('force-ocean').textContent = totalOcean.toFixed(1);
            document.getElementById('force-bh').textContent = totalBH.toFixed(1);
            
            const ratio = totalOcean / (totalGrav + 0.01);
            let state = '';
            if (ratio > 1.5) state = 'ğŸ”µ EXPANSION ACCÃ‰LÃ‰RÃ‰E';
            else if (ratio > 0.9) state = 'âœ… Ã‰QUILIBRE DYNAMIQUE';
            else if (ratio > 0.5) state = 'âš ï¸ EXPANSION MODÃ‰RÃ‰E';
            else state = 'âŒ CONTRACTION';
            document.getElementById('state').textContent = state;
        }
        
        function integrate() {
            const dt = PHYSICS.DT * CONFIG.speed;
            const damping = CONFIG.mode === 'janus' ? 0.997 : 0.999;
            
            UNIVERSE.galaxies.forEach(g => {
                const accel = g.force.clone().divideScalar(g.mass);
                g.velocity.add(accel.multiplyScalar(dt));
                g.velocity.multiplyScalar(damping);
                g.position.add(g.velocity.clone().multiplyScalar(dt));
                
                // Keep in bounds
                const r = Math.sqrt(g.position.x * g.position.x + g.position.z * g.position.z);
                if (r > PHYSICS.UNIVERSE_RADIUS * 0.95) {
                    // Galaxy exits observable universe - create new one
                    if (CONFIG.scenario === 'bigbang' || CONFIG.scenario === 'desi') {
                        spawnNewGalaxy();
                    }
                    g.position.x *= 0.9;
                    g.position.z *= 0.9;
                }
                
                g.update();
            });
            
            UNIVERSE.time += dt;
            UNIVERSE.cosmicTime += dt * 0.1;
        }
        
        function spawnNewGalaxy() {
            // Spawn at edge coming inward (for continuous observation)
            const angle = Math.random() * Math.PI * 2;
            const r = PHYSICS.UNIVERSE_RADIUS * 0.3;
            const mass = 100 + Math.random() * 600;
            
            const pos = new THREE.Vector3(
                r * Math.cos(angle),
                (Math.random() - 0.5) * 10,
                r * Math.sin(angle)
            );
            
            // Orbital velocity
            const speed = Math.sqrt(PHYSICS.G * 5000 / r) * 0.15;
            const vel = new THREE.Vector3(-Math.sin(angle), 0, Math.cos(angle)).multiplyScalar(speed);
            
            const galaxy = new Galaxy(mass, pos, vel);
            UNIVERSE.galaxies.push(galaxy);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SCENARIOS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function clearUniverse() {
            UNIVERSE.galaxies.forEach(g => galaxyGroup.remove(g.mesh));
            UNIVERSE.voids.forEach(v => voidGroup.remove(v.mesh));
            UNIVERSE.galaxies = [];
            UNIVERSE.voids = [];
            UNIVERSE.time = 0;
            UNIVERSE.cosmicTime = 0;
        }
        
        function loadScenario(name) {
            clearUniverse();
            CONFIG.scenario = name;
            
            document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('sc-' + name)?.classList.add('active');
            
            createOcean();
            
            switch(name) {
                case 'observable': createObservableUniverse(); break;
                case 'bigbang': createBigBang(); break;
                case 'milkyway': createMilkyWay(); break;
                case 'desi': createDESITest(); break;
            }
        }
        
        function createObservableUniverse() {
            // Large-scale structure with voids and filaments
            const galaxyCount = 25;
            
            // Create voids first
            for (let i = 0; i < 4; i++) {
                const angle = (i / 4) * Math.PI * 2 + Math.random() * 0.5;
                const r = 150 + Math.random() * 150;
                const pos = new THREE.Vector3(
                    r * Math.cos(angle),
                    (Math.random() - 0.5) * 30,
                    r * Math.sin(angle)
                );
                const v = new Void(pos, 60 + Math.random() * 40, 2000 + Math.random() * 3000);
                UNIVERSE.voids.push(v);
            }
            
            // Create galaxies in filaments (avoiding voids)
            for (let i = 0; i < galaxyCount; i++) {
                let pos, attempts = 0;
                do {
                    const angle = Math.random() * Math.PI * 2;
                    const r = 50 + Math.random() * 350;
                    pos = new THREE.Vector3(
                        r * Math.cos(angle) + (Math.random() - 0.5) * 50,
                        (Math.random() - 0.5) * 15,
                        r * Math.sin(angle) + (Math.random() - 0.5) * 50
                    );
                    attempts++;
                } while (isInVoid(pos) && attempts < 20);
                
                const mass = 150 + Math.random() * 800;
                const speed = Math.sqrt(PHYSICS.G * galaxyCount * 300 / Math.max(50, pos.length())) * 0.12;
                const vel = new THREE.Vector3(-pos.z, 0, pos.x).normalize().multiplyScalar(speed);
                
                UNIVERSE.galaxies.push(new Galaxy(mass, pos, vel));
            }
        }
        
        function isInVoid(pos) {
            for (const v of UNIVERSE.voids) {
                if (pos.distanceTo(v.position) < v.radius * 0.8) return true;
            }
            return false;
        }
        
        function createBigBang() {
            // Start VERY concentrated, then expand with ACCELERATION
            // Key: initial forces are WEAK, then grow as void expands
            const count = 35;
            
            for (let i = 0; i < count; i++) {
                const theta = Math.random() * Math.PI * 2;
                const r = Math.random() * 25;  // Very tight initial cluster
                const mass = 100 + Math.random() * 500;
                
                const pos = new THREE.Vector3(
                    r * Math.cos(theta),
                    (Math.random() - 0.5) * 3,
                    r * Math.sin(theta)
                );
                
                // VERY WEAK initial velocity - the ocean will accelerate them!
                const vel = pos.clone().normalize().multiplyScalar(0.1 + Math.random() * 0.2);
                vel.y = 0;
                
                UNIVERSE.galaxies.push(new Galaxy(mass, pos, vel));
            }
            
            // The central void will form and GROW, pushing galaxies outward
            // with INCREASING force as more ocean accumulates
        }
        
        function createMilkyWay() {
            // Detailed view of our galaxy with flat rotation curve
            
            // Central supermassive black hole (Sgr A*)
            const sgrA = new Galaxy(PHYSICS.BLACK_HOLE_MASS, new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, 0));
            sgrA.hasBlackHole = true;
            sgrA.blackHoleMass = PHYSICS.BLACK_HOLE_MASS;
            UNIVERSE.galaxies.push(sgrA);
            
            // Stars/clusters at various radii - should have FLAT rotation curve!
            for (let i = 0; i < 25; i++) {
                const angle = Math.random() * Math.PI * 2;
                const r = 20 + Math.random() * 250;
                const mass = 15 + Math.random() * 80;
                
                const pos = new THREE.Vector3(
                    r * Math.cos(angle),
                    (Math.random() - 0.5) * 2,  // Very flat disk
                    r * Math.sin(angle)
                );
                
                // In Janus: rotation velocity is CONSTANT regardless of radius
                // Because the ocean provides additional "support"
                // This replaces "dark matter halo" explanation!
                const vFlat = 2.5;  // Flat rotation velocity
                const vel = new THREE.Vector3(-Math.sin(angle), 0, Math.cos(angle)).multiplyScalar(vFlat);
                
                UNIVERSE.galaxies.push(new Galaxy(mass, pos, vel));
            }
        }
        
        function createDESITest() {
            // Test scenario showing ACCELERATION with distance
            // Inner galaxies move slow, outer galaxies ACCELERATE
            const count = 25;
            
            // Create rings at different distances
            const rings = [
                { r: 60, count: 6, speed: 0.3 },
                { r: 120, count: 8, speed: 0.5 },
                { r: 200, count: 8, speed: 0.8 },
                { r: 300, count: 3, speed: 1.2 },
            ];
            
            rings.forEach(ring => {
                for (let i = 0; i < ring.count; i++) {
                    const angle = (i / ring.count) * Math.PI * 2 + Math.random() * 0.3;
                    const r = ring.r + (Math.random() - 0.5) * 30;
                    const mass = 150 + Math.random() * 400;
                    
                    const pos = new THREE.Vector3(
                        r * Math.cos(angle),
                        (Math.random() - 0.5) * 8,
                        r * Math.sin(angle)
                    );
                    
                    // Tangential + slight outward velocity
                    const tangent = new THREE.Vector3(-Math.sin(angle), 0, Math.cos(angle));
                    const radial = new THREE.Vector3(Math.cos(angle), 0, Math.sin(angle));
                    const vel = tangent.multiplyScalar(ring.speed * 0.5).add(radial.multiplyScalar(ring.speed * 0.2));
                    
                    UNIVERSE.galaxies.push(new Galaxy(mass, pos, vel));
                }
            });
            
            // Add voids between rings - they will push the outer galaxies faster!
            const voidPositions = [
                { x: 150, z: 0 },
                { x: -75, z: 130 },
                { x: -75, z: -130 },
            ];
            
            voidPositions.forEach(vp => {
                const v = new Void(
                    new THREE.Vector3(vp.x, 0, vp.z),
                    50 + Math.random() * 30,
                    2000 + Math.random() * 2000
                );
                UNIVERSE.voids.push(v);
            });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BACKGROUND
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function createBackground() {
            const geom = new THREE.BufferGeometry();
            const positions = [];
            
            for (let i = 0; i < 3000; i++) {
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                const r = PHYSICS.UNIVERSE_RADIUS * 2;
                
                positions.push(
                    r * Math.sin(phi) * Math.cos(theta),
                    r * Math.sin(phi) * Math.sin(theta),
                    r * Math.cos(phi)
                );
            }
            
            geom.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.5, transparent: true, opacity: 0.3 });
            scene.add(new THREE.Points(geom, mat));
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CAMERA CONTROLS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let camTheta = 0.3, camPhi = Math.PI / 2.5, camRadius = 450;
        let dragging = false, lastMouse = { x: 0, y: 0 };
        
        function updateCamera() {
            camera.position.x = camRadius * Math.sin(camPhi) * Math.cos(camTheta);
            camera.position.y = camRadius * Math.cos(camPhi);
            camera.position.z = camRadius * Math.sin(camPhi) * Math.sin(camTheta);
            camera.lookAt(0, 0, 0);
        }
        
        canvas.addEventListener('mousedown', e => { dragging = true; lastMouse = { x: e.clientX, y: e.clientY }; });
        canvas.addEventListener('mousemove', e => {
            if (!dragging) return;
            camTheta -= (e.clientX - lastMouse.x) * 0.005;
            camPhi = Math.max(0.1, Math.min(Math.PI - 0.1, camPhi + (e.clientY - lastMouse.y) * 0.005));
            lastMouse = { x: e.clientX, y: e.clientY };
            updateCamera();
        });
        canvas.addEventListener('mouseup', () => dragging = false);
        canvas.addEventListener('mouseleave', () => dragging = false);
        canvas.addEventListener('wheel', e => {
            camRadius = Math.max(80, Math.min(1000, camRadius + e.deltaY * 0.5));
            updateCamera();
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI CONTROLS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function setMode(mode) {
            CONFIG.mode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + mode)?.classList.add('active');
            document.getElementById('top-mode').textContent = mode === 'janus' ? 'JANUS+DESI' : mode.toUpperCase();
            
            oceanGroup.visible = mode === 'janus';
            voidGroup.visible = mode === 'janus';
            
            reset();
        }
        
        function togglePause() {
            CONFIG.paused = !CONFIG.paused;
            document.getElementById('btn-pause').textContent = CONFIG.paused ? 'â–¶ Play' : 'â¸ Pause';
            document.getElementById('btn-pause').classList.toggle('active', !CONFIG.paused);
        }
        
        function reset() {
            loadScenario(CONFIG.scenario);
        }
        
        function toggleFS() {
            document.body.classList.toggle('fullscreen');
        }
        
        // Sliders
        document.getElementById('ctrl-speed').oninput = function() {
            CONFIG.speed = parseFloat(this.value);
            document.getElementById('val-speed').textContent = CONFIG.speed.toFixed(1) + 'Ã—';
        };
        
        document.getElementById('ctrl-gravity').oninput = function() {
            CONFIG.gravity = parseFloat(this.value);
            document.getElementById('val-gravity').textContent = CONFIG.gravity.toFixed(1);
        };
        
        document.getElementById('ctrl-ratio').oninput = function() {
            CONFIG.massRatio = parseFloat(this.value);
            document.getElementById('val-ratio').textContent = CONFIG.massRatio + 'Ã—';
        };
        
        document.getElementById('ctrl-pressure').oninput = function() {
            CONFIG.oceanPressure = parseFloat(this.value);
            document.getElementById('val-pressure').textContent = CONFIG.oceanPressure.toFixed(1);
        };
        
        document.getElementById('ctrl-evolution').oninput = function() {
            CONFIG.darkEnergyEvolution = parseFloat(this.value);
            document.getElementById('val-evolution').textContent = CONFIG.darkEnergyEvolution.toFixed(1);
        };
        
        document.addEventListener('keydown', e => {
            if (e.key === 'f' || e.key === 'F' || e.key === 'Escape') toggleFS();
            if (e.key === ' ') { e.preventDefault(); togglePause(); }
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATISTICS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function updateStats() {
            const n = UNIVERSE.galaxies.length;
            document.getElementById('stat-galaxies').textContent = n;
            document.getElementById('top-galaxies').textContent = n;
            
            const massPos = UNIVERSE.galaxies.reduce((s, g) => s + g.mass, 0);
            document.getElementById('stat-mass-pos').textContent = Math.round(massPos);
            document.getElementById('stat-mass-neg').textContent = Math.round(massPos * CONFIG.massRatio);
            document.getElementById('top-ocean').textContent = (massPos * CONFIG.massRatio / 1000).toFixed(1) + 'K';
            
            document.getElementById('stat-voids').textContent = UNIVERSE.voids.length;
            document.getElementById('stat-pressure').textContent = UNIVERSE.avgPressure.toFixed(1);
            document.getElementById('top-pressure').textContent = UNIVERSE.avgPressure.toFixed(1);
            
            // VELOCITY BY ZONE - shows acceleration with distance!
            let innerVel = 0, outerVel = 0, innerCount = 0, outerCount = 0;
            const midRadius = 150;
            
            UNIVERSE.galaxies.forEach(g => {
                const r = Math.sqrt(g.position.x * g.position.x + g.position.z * g.position.z);
                const v = g.velocity.length();
                
                if (r < midRadius) {
                    innerVel += v;
                    innerCount++;
                } else {
                    outerVel += v;
                    outerCount++;
                }
            });
            
            innerVel = innerCount > 0 ? innerVel / innerCount : 0;
            outerVel = outerCount > 0 ? outerVel / outerCount : 0;
            
            // Display velocity by zone
            document.getElementById('vel-inner').textContent = innerVel.toFixed(2);
            document.getElementById('vel-outer').textContent = outerVel.toFixed(2);
            const velRatio = innerVel > 0.01 ? (outerVel / innerVel) : 1;
            document.getElementById('vel-ratio').textContent = velRatio.toFixed(2) + 'Ã—';
            document.getElementById('vel-ratio').style.color = velRatio > 1 ? 'var(--positive)' : 'var(--negative)';
            
            // Stability based on velocity distribution
            let avgVel = 0;
            UNIVERSE.galaxies.forEach(g => avgVel += g.velocity.length());
            avgVel /= Math.max(1, n);
            const stability = Math.max(0, Math.min(100, 100 - avgVel * 20));
            document.getElementById('stat-stability').textContent = Math.round(stability) + '%';
            
            document.getElementById('top-time').textContent = UNIVERSE.cosmicTime.toFixed(1) + ' Gyr';
            
            // Acceleration indicator: outer should be faster than inner!
            const accelRatio = outerCount > 0 && innerCount > 0 ? outerVel / (innerVel + 0.01) : 1;
            const accelSymbol = accelRatio > 1.2 ? 'â†‘â†‘' : accelRatio > 1 ? 'â†‘' : 'â†’';
            document.getElementById('top-accel').textContent = accelSymbol + ' ' + accelRatio.toFixed(1) + 'Ã—';
            
            // Predictions
            const isJanus = CONFIG.mode === 'janus';
            document.getElementById('pred-flat').textContent = isJanus ? 'âœ… Courbes rotation plates' : 'âŒ Courbes rotation plates';
            document.getElementById('pred-stable').textContent = stability > 60 ? 'âœ… Galaxies stables' : 'âŒ Galaxies stables';
            document.getElementById('pred-disk').textContent = isJanus ? 'âœ… Galaxies aplaties' : 'âš ï¸ Galaxies aplaties';
            document.getElementById('pred-accel').textContent = accelRatio > 1 ? 'âœ… Expansion accÃ©lÃ©rÃ©e' : 'âš ï¸ Expansion accÃ©lÃ©rÃ©e';
            document.getElementById('pred-desi').textContent = isJanus && accelRatio > 1.1 ? 'âœ… w(t) Ã©volutif (DESI)' : 'â³ w(t) Ã©volutif (DESI)';
            document.getElementById('pred-voids').textContent = UNIVERSE.voids.length > 0 ? 'âœ… Structure lacunaire' : 'â³ Structure lacunaire';
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANIMATION LOOP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let lastTime = performance.now();
        let frameCount = 0;
        
        function animate() {
            requestAnimationFrame(animate);
            
            frameCount++;
            const now = performance.now();
            if (now - lastTime >= 1000) {
                document.getElementById('top-fps').textContent = frameCount;
                frameCount = 0;
                lastTime = now;
            }
            
            if (!CONFIG.paused && UNIVERSE.galaxies.length > 0) {
                computeForces();
                integrate();
                
                if (Math.floor(UNIVERSE.time * 10) % 3 === 0) {
                    updateStats();
                }
            }
            
            // Rotate ocean slowly
            if (UNIVERSE.oceanParticles) {
                UNIVERSE.oceanParticles.rotation.y += 0.0002 * CONFIG.speed;
            }
            
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        createBackground();
        updateCamera();
        loadScenario('observable');
        animate();
    </script>
</body>
</html>
